{
  "properties": {
    "displayName": "Enterprise Storage Security - Comprehensive Secure Transfer and Protection Requirements",
    "description": "Enforces comprehensive security requirements for Azure Storage accounts including secure transfer (HTTPS), minimum TLS version, secure access configurations, and advanced threat protection. Ensures compliance with data protection standards and prevents insecure storage configurations that could lead to data breaches or unauthorized access.",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "version": "2.0.0",
      "category": "Storage",
      "preview": false,
      "compliance": {
        "iso27001": {
          "controls": ["A.10.1.1", "A.10.1.2", "A.13.1.1", "A.13.2.1"],
          "description": "Cryptographic controls and secure network communications"
        },
        "soc2": {
          "trustServicesCriteria": ["CC6.1", "CC6.6", "CC6.7"],
          "description": "System security design and implementation"
        },
        "azureSecurityBenchmark": {
          "controls": ["DP-3", "DP-4", "DP-6", "NS-2"],
          "description": "Data protection and secure communications"
        },
        "cisAzure": {
          "controls": ["3.1", "3.2", "3.3", "3.7", "3.15"],
          "description": "Storage account security configuration"
        },
        "pciDss": {
          "requirements": ["4.1", "4.2", "6.2.1"],
          "description": "Secure transmission of cardholder data"
        }
      },
      "implementationGuidance": {
        "bestPractices": [
          "Enable secure transfer (HTTPS) for all storage accounts",
          "Set minimum TLS version to 1.2 or higher",
          "Disable public blob access unless explicitly required",
          "Use private endpoints for secure connectivity",
          "Enable Advanced Threat Protection for storage accounts",
          "Configure appropriate firewall rules and network ACLs",
          "Enable blob versioning and soft delete for data protection"
        ],
        "securityConsiderations": [
          "Secure transfer prevents man-in-the-middle attacks",
          "Minimum TLS version ensures cryptographic strength",
          "Public access restrictions prevent data exposure",
          "Network restrictions limit attack surface"
        ]
      }
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Policy Effect",
          "description": "The effect determines what happens when the policy rule is evaluated. Use 'Audit' to identify non-compliant resources, 'Deny' to prevent creation/modification, or 'Modify' to automatically remediate."
        },
        "allowedValues": [
          "Audit",
          "Deny", 
          "Modify",
          "Disabled"
        ],
        "defaultValue": "Deny"
      },
      "minimumTlsVersion": {
        "type": "String",
        "metadata": {
          "displayName": "Minimum TLS Version",
          "description": "The minimum TLS version required for storage account connections"
        },
        "allowedValues": [
          "TLS1_0",
          "TLS1_1", 
          "TLS1_2",
          "TLS1_3"
        ],
        "defaultValue": "TLS1_2"
      },
      "allowBlobPublicAccess": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Allow Blob Public Access",
          "description": "Whether to allow public access to blobs. Set to false for enhanced security."
        },
        "defaultValue": false
      },
      "requireInfrastructureEncryption": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Require Infrastructure Encryption",
          "description": "Whether to require infrastructure encryption (double encryption) for enhanced data protection"
        },
        "defaultValue": false
      },
      "allowSharedKeyAccess": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Allow Shared Key Access",
          "description": "Whether to allow Shared Key authorization. Set to false to enforce Azure AD authentication only."
        },
        "defaultValue": true
      },
      "exemptedStorageAccountTypes": {
        "type": "Array",
        "metadata": {
          "displayName": "Exempted Storage Account Types",
          "description": "Array of storage account types to exempt from secure transfer requirements"
        },
        "defaultValue": []
      },
      "exemptedResourceGroups": {
        "type": "Array",
        "metadata": {
          "displayName": "Exempted Resource Groups",
          "description": "Array of resource group names to exempt from this policy"
        },
        "defaultValue": [
          "NetworkWatcherRG",
          "LogAnalyticsDefaultResources"
        ]
      },
      "exemptedStorageAccounts": {
        "type": "Array",
        "metadata": {
          "displayName": "Exempted Storage Accounts",
          "description": "Array of storage account resource IDs to exempt from this policy"
        },
        "defaultValue": []
      },
      "enforcedStorageAccountKinds": {
        "type": "Array",
        "metadata": {
          "displayName": "Enforced Storage Account Kinds",
          "description": "Array of storage account kinds to which this policy applies"
        },
        "defaultValue": [
          "Storage",
          "StorageV2",
          "BlobStorage",
          "FileStorage",
          "BlockBlobStorage"
        ]
      },
      "requirePrivateEndpoint": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Require Private Endpoint",
          "description": "Whether to require private endpoints for storage accounts (disables public network access)"
        },
        "defaultValue": false
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "field": "kind",
            "in": "[parameters('enforcedStorageAccountKinds')]"
          },
          {
            "not": {
              "anyOf": [
                {
                  "field": "resourceGroup",
                  "in": "[parameters('exemptedResourceGroups')]"
                },
                {
                  "field": "id",
                  "in": "[parameters('exemptedStorageAccounts')]"
                },
                {
                  "field": "Microsoft.Storage/storageAccounts/sku.name",
                  "in": "[parameters('exemptedStorageAccountTypes')]"
                }
              ]
            }
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
                "notEquals": true
              },
              {
                "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
                "notEquals": "[parameters('minimumTlsVersion')]"
              },
              {
                "allOf": [
                  {
                    "value": "[parameters('allowBlobPublicAccess')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/allowBlobPublicAccess",
                    "notEquals": false
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "value": "[parameters('requireInfrastructureEncryption')]",
                    "equals": true
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/encryption.requireInfrastructureEncryption",
                    "notEquals": true
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "value": "[parameters('allowSharedKeyAccess')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/allowSharedKeyAccess",
                    "notEquals": false
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "value": "[parameters('requirePrivateEndpoint')]",
                    "equals": true
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/publicNetworkAccess",
                    "notEquals": "Disabled"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]",
        "details": {
          "conflictEffect": "audit",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab"
          ],
          "operations": [
            {
              "operation": "addOrReplace",
              "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
              "value": true
            },
            {
              "operation": "addOrReplace",
              "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
              "value": "[parameters('minimumTlsVersion')]"
            },
            {
              "condition": "[equals(parameters('allowBlobPublicAccess'), false())]",
              "operation": "addOrReplace",
              "field": "Microsoft.Storage/storageAccounts/allowBlobPublicAccess",
              "value": false
            },
            {
              "condition": "[equals(parameters('requireInfrastructureEncryption'), true())]",
              "operation": "addOrReplace", 
              "field": "Microsoft.Storage/storageAccounts/encryption.requireInfrastructureEncryption",
              "value": true
            },
            {
              "condition": "[equals(parameters('allowSharedKeyAccess'), false())]",
              "operation": "addOrReplace",
              "field": "Microsoft.Storage/storageAccounts/allowSharedKeyAccess", 
              "value": false
            },
            {
              "condition": "[equals(parameters('requirePrivateEndpoint'), true())]",
              "operation": "addOrReplace",
              "field": "Microsoft.Storage/storageAccounts/publicNetworkAccess",
              "value": "Disabled"
            }
          ]
        }
      }
    }
  }
}

