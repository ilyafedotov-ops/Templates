{
  "kind": "Office365",
  "properties": {
    "tenantId": "{{tenantId}}",
    "dataTypes": [
      {
        "name": "Exchange",
        "state": "enabled"
      },
      {
        "name": "SharePoint", 
        "state": "enabled"
      },
      {
        "name": "Teams",
        "state": "enabled"
      }
    ],
    "connectorUiConfig": {
      "title": "Office 365",
      "publisher": "Microsoft",
      "descriptionMarkdown": "Office 365 logs provide insights into user activities across Exchange Online, SharePoint Online, and Microsoft Teams. Connect to monitor file access, email activities, team collaboration, and detect potential security threats.",
      "graphQueries": [
        {
          "metricName": "Total data received",
          "legend": "OfficeActivity (Exchange)",
          "baseQuery": "OfficeActivity | where OfficeWorkload == \"Exchange\""
        },
        {
          "metricName": "Total data received",
          "legend": "OfficeActivity (SharePoint)",
          "baseQuery": "OfficeActivity | where OfficeWorkload == \"SharePoint\""
        },
        {
          "metricName": "Total data received",
          "legend": "OfficeActivity (Teams)",
          "baseQuery": "OfficeActivity | where OfficeWorkload == \"MicrosoftTeams\""
        }
      ],
      "sampleQueries": [
        {
          "description": "Failed login attempts to Office 365",
          "query": "OfficeActivity | where Operation == \"UserLoginFailed\" | summarize count() by UserType, bin(TimeGenerated, 1h) | order by TimeGenerated desc"
        },
        {
          "description": "File sharing activities in SharePoint/OneDrive",
          "query": "OfficeActivity | where OfficeWorkload == \"SharePoint\" and Operation in (\"SharingSet\", \"AnonymousLinkCreated\", \"CompanyLinkCreated\") | project TimeGenerated, UserId, Operation, OfficeObjectId, ClientIP"
        },
        {
          "description": "Email forwarding rule changes",
          "query": "OfficeActivity | where OfficeWorkload == \"Exchange\" and Operation in (\"New-InboxRule\", \"Set-InboxRule\") | project TimeGenerated, UserId, Operation, Parameters"
        },
        {
          "description": "Teams external user activities",
          "query": "OfficeActivity | where OfficeWorkload == \"MicrosoftTeams\" and UserType == \"Guest\" | summarize count() by UserId, Operation, bin(TimeGenerated, 1d)"
        }
      ],
      "dataTypes": [
        {
          "name": "OfficeActivity (Exchange)",
          "lastDataReceivedQuery": "OfficeActivity | where OfficeWorkload == \"Exchange\" | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
        },
        {
          "name": "OfficeActivity (SharePoint)",
          "lastDataReceivedQuery": "OfficeActivity | where OfficeWorkload == \"SharePoint\" | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
        },
        {
          "name": "OfficeActivity (Teams)", 
          "lastDataReceivedQuery": "OfficeActivity | where OfficeWorkload == \"MicrosoftTeams\" | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
        }
      ],
      "connectivityCriteria": [
        {
          "type": "SentinelKindsV2",
          "value": ["Office365"]
        }
      ],
      "availability": {
        "status": 1,
        "isPreview": false
      },
      "permissions": {
        "resourceProvider": [
          {
            "provider": "Microsoft.OperationalInsights/workspaces",
            "permissionsDisplayText": "Write permissions are required.",
            "providerDisplayName": "Workspace",
            "scope": "Workspace",
            "requiredPermissions": {
              "write": true,
              "read": false,
              "delete": false
            }
          }
        ],
        "tenant": ["GlobalAdmin", "SecurityAdmin"],
        "customs": [
          {
            "name": "Office 365 Audit Logging",
            "description": "Office 365 audit logging must be enabled in the Security & Compliance Center."
          }
        ]
      },
      "instructionSteps": [
        {
          "title": "1. Enable Office 365 Audit Logging",
          "description": "Enable audit logging in the Microsoft 365 Security & Compliance Center before connecting to Microsoft Sentinel.",
          "instructions": [
            {
              "parameters": {
                "title": "Enable Audit Logging",
                "instructionSteps": [
                  {
                    "title": "",
                    "description": "1. Go to **Microsoft 365 Security & Compliance Center** (https://compliance.microsoft.com)\n2. Navigate to **Audit** under **Solutions**\n3. Click **Turn on auditing** if not already enabled\n4. Wait for audit logging to be activated (can take up to 24 hours)\n5. Verify audit logging is working by running a search in the Audit log"
                  }
                ]
              },
              "type": "InstructionStepsGroup"
            }
          ]
        },
        {
          "title": "2. Connect Office 365",
          "description": "Select the Office 365 workloads you want to connect to Microsoft Sentinel.",
          "instructions": [
            {
              "parameters": {
                "connectorKind": "Office365",
                "title": "Office 365",
                "enable": true
              },
              "type": "SentinelResourceProvider"
            }
          ]
        },
        {
          "title": "3. Configure advanced audit logging (Optional)",
          "description": "Enable advanced audit events for enhanced monitoring capabilities.",
          "instructions": [
            {
              "parameters": {
                "title": "Advanced Audit Configuration",
                "instructionSteps": [
                  {
                    "title": "",
                    "description": "1. In **Microsoft 365 Compliance Center**, go to **Audit**\n2. Click **Audit retention policies**\n3. Create policies for different user types (Admin, Standard)\n4. Set retention periods (up to 10 years for E5 licenses)\n5. Enable **Advanced Audit** features like crucial events\n6. Configure **Mailbox auditing** for Exchange Online"
                  }
                ]
              },
              "type": "InstructionStepsGroup"
            }
          ]
        }
      ]
    }
  }
}