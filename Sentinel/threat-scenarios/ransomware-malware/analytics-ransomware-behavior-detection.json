{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "2.0.0.0",
  "metadata": {
    "title": "Advanced Ransomware Behavior Detection with ML Analytics",
    "description": "Comprehensive ransomware detection using behavioral analysis, file system monitoring, process execution patterns, and machine learning to identify ransomware activities including encryption, file manipulation, and extortion attempts",
    "author": "Enterprise Security Team",
    "version": "2.0.0",
    "lastModified": "2025-01-01T00:00:00Z",
    "compliance": ["ISO27001:A.12.2.1", "SOC2:CC7.1", "NIST:SI-4", "PCI-DSS:11.4"],
    "mitreAttack": {
      "techniques": ["T1486", "T1490", "T1083", "T1082", "T1057", "T1012", "T1047", "T1543.003"],
      "tactics": ["Impact", "Discovery", "Defense Evasion", "Persistence"],
      "subTechniques": ["Data Encrypted for Impact", "Inhibit System Recovery", "File and Directory Discovery"]
    },
    "dataConnectors": ["SecurityEvents", "WindowsFirewall", "MicrosoftThreatProtection", "Office365", "AzureStorage"],
    "queryFrequency": "PT5M",
    "queryPeriod": "PT1H", 
    "alertRuleTemplateName": "advanced-ransomware-behavior-detection"
  },
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Log Analytics workspace"
      }
    },
    "ruleId": {
      "type": "string",
      "defaultValue": "adv-ransomware-behavior",
      "metadata": {
        "description": "Unique identifier for the analytics rule"
      }
    },
    "ransomwareThreshold": {
      "type": "int",
      "defaultValue": 80,
      "minValue": 60,
      "maxValue": 95,
      "metadata": {
        "description": "ML ransomware behavior score threshold (60-95)"
      }
    },
    "criticalFileShares": {
      "type": "array",
      "defaultValue": [
        "\\\\fileserver\\shared",
        "\\\\nas\\documents", 
        "\\\\backup\\data"
      ],
      "metadata": {
        "description": "Critical file shares to monitor for ransomware activity"
      }
    },
    "sensitiveFileExtensions": {
      "type": "array",
      "defaultValue": [
        ".xlsx", ".docx", ".pdf", ".pptx",
        ".jpg", ".png", ".mp4", ".zip",
        ".sql", ".db", ".pst", ".vhd"
      ],
      "metadata": {
        "description": "File extensions commonly targeted by ransomware"
      }
    }
  },
  "variables": {
    "alertRuleName": "[concat('Advanced Ransomware Behavior Detection - ', parameters('ruleId'))]",
    "alertRuleDescription": "Leverages machine learning and behavioral analytics to detect sophisticated ransomware attacks including file encryption patterns, system recovery inhibition, lateral movement, and persistence mechanisms"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "apiVersion": "2023-02-01-preview",
      "name": "[format('{0}/Microsoft.SecurityInsights/{1}', parameters('workspaceName'), parameters('ruleId'))]",
      "properties": {
        "displayName": "[variables('alertRuleName')]",
        "description": "[variables('alertRuleDescription')]",
        "enabled": true,
        "kind": "Scheduled",
        "severity": "High",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT1H",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "suppressionDuration": "PT30M",
        "suppressionEnabled": true,
        "tactics": ["Impact", "Discovery", "DefenseEvasion"],
        "techniques": ["T1486", "T1490", "T1083"],
        "subTechniques": ["T1486", "T1490", "T1083.001"],
        "query": "let analysisWindow = 1h;\nlet ransomwareThreshold = toint('[parameters('ransomwareThreshold')]');\nlet criticalShares = dynamic('[parameters('criticalFileShares')]');\nlet targetFileExtensions = dynamic('[parameters('sensitiveFileExtensions')]');\n// Define ransomware-related processes and commands\nlet ransomwareProcesses = dynamic([\n    \"vssadmin.exe delete shadows\",\n    \"wmic shadowcopy delete\",\n    \"bcdedit.exe /set {default} bootstatuspolicy ignoreallfailures\",\n    \"bcdedit.exe /set {default} recoveryenabled no\",\n    \"wbadmin delete catalog -quiet\",\n    \"cipher.exe /w\",\n    \"schtasks.exe /delete\",\n    \"reg.exe delete\",\n    \"netsh.exe firewall\",\n    \"powershell.exe -enc\",\n    \"cmd.exe /c\"\n]);\n// Define known ransomware file extensions\nlet ransomwareExtensions = dynamic([\n    \".locked\", \".encrypted\", \".crypto\", \".crypt\", \".enc\", \".ransomed\",\n    \".xtbl\", \".cerber\", \".locky\", \".zepto\", \".odin\", \".thor\",\n    \".aaa\", \".abc\", \".xyz\", \".zzz\", \".666\", \".777\",\n    \".wannacry\", \".wcry\", \".wncry\", \".dharma\", \".wallet\",\n    \".onion\", \".decrypt2017\", \".crjoker\", \".EnCiPhErEd\"\n]);\n// File system activity analysis for encryption patterns\nlet fileSystemActivity = \n    SecurityEvents\n    | where TimeGenerated >= ago(analysisWindow)\n    | where EventID in (4663, 4656, 4658, 4660) // File access, handle operations, delete\n    | where isnotempty(ProcessName) and isnotempty(ObjectName)\n    | extend \n        ComputerName = toupper(Computer),\n        ProcessPath = ProcessName,\n        FileName = extract(@\"[^\\\\]*$\", 0, ObjectName),\n        FileExtension = tolower(extract(@\"\\.[^.\\\\]*$\", 0, ObjectName)),\n        FilePath = ObjectName,\n        UserAccount = coalesce(TargetUserName, Account),\n        \n        // File operation classification\n        Operation = case(\n            EventID == 4663 and AccessMask contains \"0x2\", \"Write\",\n            EventID == 4663 and AccessMask contains \"0x1\", \"Read\",\n            EventID == 4660, \"Delete\",\n            \"Other\"\n        ),\n        \n        // Risk indicators\n        IsTargetFileType = FileExtension in (targetFileExtensions),\n        IsRansomwareExtension = FileExtension in (ransomwareExtensions),\n        IsCriticalShare = ObjectName has_any (criticalShares),\n        IsSystemFile = ObjectName startswith @\"C:\\Windows\" or ObjectName startswith @\"C:\\Program Files\",\n        IsUserData = ObjectName contains @\"\\Users\\\" or ObjectName contains @\"\\Documents\\\",\n        \n        // Pattern indicators\n        IsMassFileOperation = false, // Will be calculated in aggregation\n        IsEncryptionPattern = (\n            Operation == \"Write\" and \n            (ProcessPath contains \"crypt\" or ProcessPath contains \"lock\" or ProcessPath contains \"encrypt\")\n        ),\n        \n        // Process risk scoring\n        ProcessRiskScore = case(\n            ProcessPath contains \"powershell\" and ObjectName contains \".exe\", 20,\n            ProcessPath contains \"cmd\" and Operation == \"Write\", 15,\n            ProcessPath contains \"wmic\", 15,\n            ProcessPath contains \"vssadmin\", 25,\n            ProcessPath contains \"bcdedit\", 20,\n            ProcessPath contains \"cipher\", 30,\n            5\n        ),\n        \n        // File risk scoring\n        FileRiskScore = case(\n            IsRansomwareExtension, 50,\n            IsTargetFileType and IsCriticalShare, 30,\n            IsTargetFileType and IsUserData, 25,\n            IsTargetFileType, 15,\n            IsCriticalShare, 20,\n            10\n        ),\n        \n        // Operation risk scoring\n        OperationRiskScore = case(\n            Operation == \"Delete\" and IsUserData, 20,\n            Operation == \"Write\" and IsEncryptionPattern, 35,\n            Operation == \"Write\" and IsTargetFileType, 25,\n            5\n        )\n    | extend \n        TotalRiskScore = ProcessRiskScore + FileRiskScore + OperationRiskScore;\n// Process execution analysis for ransomware behavior\nlet processAnalysis = \n    SecurityEvents\n    | where TimeGenerated >= ago(analysisWindow)\n    | where EventID in (4688, 4689) // Process creation and termination\n    | where isnotempty(NewProcessName) or isnotempty(ProcessName)\n    | extend \n        ComputerName = toupper(Computer),\n        ProcessPath = coalesce(NewProcessName, ProcessName),\n        CommandLine = coalesce(CommandLine, \"\"),\n        UserAccount = coalesce(TargetUserName, Account),\n        ParentProcessPath = coalesce(ParentProcessName, \"\")\n    | extend \n        // Ransomware command detection\n        IsRansomwareCommand = CommandLine has_any (ransomwareProcesses),\n        IsShadowCopyDeletion = CommandLine contains \"vssadmin delete\" or CommandLine contains \"wmic shadowcopy delete\",\n        IsBootRecoveryDisabled = CommandLine contains \"bcdedit\" and (CommandLine contains \"recoveryenabled no\" or CommandLine contains \"ignoreallfailures\"),\n        IsBackupDeletion = CommandLine contains \"wbadmin delete\",\n        IsFileWiping = CommandLine contains \"cipher /w\",\n        IsPowerShellEncoded = CommandLine contains \"powershell\" and CommandLine contains \"-enc\",\n        IsServiceModification = CommandLine contains \"sc\" or CommandLine contains \"net stop\",\n        IsFirewallModification = CommandLine contains \"netsh firewall\" or CommandLine contains \"advfirewall\",\n        \n        // Process spawning patterns\n        IsSuspiciousParent = ParentProcessPath contains \"winword\" or ParentProcessPath contains \"excel\" or \n                            ParentProcessPath contains \"powerpnt\" or ParentProcessPath contains \"outlook\",\n        IsSystemProcessSpawning = ProcessPath contains @\"\\system32\\\" and \n                                 ParentProcessPath !contains @\"\\system32\\\",\n        \n        // Risk scoring for processes\n        CommandRiskScore = case(\n            IsShadowCopyDeletion, 40,\n            IsBootRecoveryDisabled, 35,\n            IsBackupDeletion, 30,\n            IsFileWiping, 25,\n            IsPowerShellEncoded, 30,\n            IsServiceModification, 20,\n            IsFirewallModification, 15,\n            IsRansomwareCommand, 35,\n            10\n        ),\n        \n        ParentRiskScore = case(\n            IsSuspiciousParent, 25,\n            IsSystemProcessSpawning, 20,\n            0\n        )\n    | extend \n        ProcessTotalRisk = CommandRiskScore + ParentRiskScore;\n// Registry modifications indicating ransomware activity\nlet registryAnalysis = \n    SecurityEvents\n    | where TimeGenerated >= ago(analysisWindow)\n    | where EventID in (4657) // Registry value modification\n    | where isnotempty(ObjectName) and ObjectName startswith \"\\\\REGISTRY\\\\\"\n    | extend \n        ComputerName = toupper(Computer),\n        RegistryKey = ObjectName,\n        ProcessPath = ProcessName,\n        UserAccount = coalesce(TargetUserName, Account),\n        \n        // Critical registry locations for ransomware\n        IsBootRegistry = RegistryKey contains \"\\\\CurrentControlSet\\\\Control\\\\SafeBoot\" or\n                        RegistryKey contains \"\\\\CurrentControlSet\\\\Control\\\\Session Manager\",\n        IsSecurityRegistry = RegistryKey contains \"\\\\Policies\\\\System\" or\n                           RegistryKey contains \"\\\\CurrentVersion\\\\Policies\",\n        IsRunRegistry = RegistryKey contains \"\\\\CurrentVersion\\\\Run\" or\n                       RegistryKey contains \"\\\\CurrentVersion\\\\RunOnce\",\n        IsServiceRegistry = RegistryKey contains \"\\\\CurrentControlSet\\\\Services\",\n        IsWallpaperRegistry = RegistryKey contains \"Control Panel\\\\Desktop\" and RegistryKey contains \"Wallpaper\",\n        \n        RegistryRiskScore = case(\n            IsBootRegistry, 30,\n            IsSecurityRegistry, 25,\n            IsRunRegistry, 20,\n            IsServiceRegistry, 15,\n            IsWallpaperRegistry, 10,\n            5\n        );\n// Network activity analysis for C2 communication\nlet networkActivity = \n    union \n    (\n        CommonSecurityLog\n        | where TimeGenerated >= ago(analysisWindow)\n        | where DeviceVendor == \"Microsoft\" and DeviceProduct == \"Windows Firewall\"\n        | extend \n            ComputerName = Computer,\n            SourceIP = SourceIP,\n            DestinationIP = DestinationIP,\n            DestinationPort = DestinationPort,\n            Protocol = Protocol,\n            Action = Activity\n    ),\n    (\n        WindowsFirewall\n        | where TimeGenerated >= ago(analysisWindow)\n        | extend \n            ComputerName = Computer,\n            SourceIP = SourceAddress,\n            DestinationIP = DestinationAddress,\n            DestinationPort = DestinationPort,\n            Protocol = Protocol,\n            Action = Action\n    )\n    | where Action == \"Allow\" or Action == \"ALLOW\"\n    | where isnotempty(DestinationIP) and DestinationIP != \"127.0.0.1\"\n    | extend \n        // Suspicious network patterns\n        IsUnusualPort = DestinationPort in (4444, 5555, 6666, 7777, 8888, 9999) or\n                       DestinationPort >= 10000,\n        IsEncryptedTraffic = DestinationPort in (443, 993, 995, 853),\n        IsTorNetwork = DestinationIP matches regex @\"^(127\\.0\\.0\\.1|10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|192\\.168\\.).*\",\n        \n        NetworkRiskScore = case(\n            IsUnusualPort and not(IsEncryptedTraffic), 20,\n            IsUnusualPort, 15,\n            IsTorNetwork, 25,\n            5\n        );\n// Aggregate analysis by computer and time window\nlet aggregatedAnalysis = \n    fileSystemActivity\n    | summarize \n        // File activity metrics\n        TotalFileOperations = count(),\n        WriteOperations = countif(Operation == \"Write\"),\n        DeleteOperations = countif(Operation == \"Delete\"),\n        ReadOperations = countif(Operation == \"Read\"),\n        UniqueFiles = dcount(ObjectName),\n        UniqueProcesses = dcount(ProcessPath),\n        \n        // Risk indicators\n        RansomwareExtensionFiles = countif(IsRansomwareExtension),\n        TargetFileTypeOperations = countif(IsTargetFileType),\n        CriticalShareAccess = countif(IsCriticalShare),\n        UserDataAccess = countif(IsUserData),\n        SystemFileAccess = countif(IsSystemFile),\n        EncryptionPatterns = countif(IsEncryptionPattern),\n        \n        // Risk scores\n        MaxFileRiskScore = max(TotalRiskScore),\n        AvgFileRiskScore = avg(TotalRiskScore),\n        TotalFileRiskExposure = sum(TotalRiskScore),\n        \n        // Evidence collection\n        AffectedFiles = make_set(ObjectName, 200),\n        RansomwareFiles = make_set_if(ObjectName, IsRansomwareExtension, 100),\n        ProcessesInvolved = make_set(ProcessPath, 50),\n        UsersInvolved = make_set(UserAccount, 20),\n        \n        // Timing analysis\n        FirstActivity = min(TimeGenerated),\n        LastActivity = max(TimeGenerated),\n        ActivityDuration = datetime_diff('minute', max(TimeGenerated), min(TimeGenerated))\n        \n        by bin(TimeGenerated, 5m), ComputerName\n    | join kind=leftouter (\n        processAnalysis\n        | summarize \n            SuspiciousProcesses = count(),\n            RansomwareCommands = countif(IsRansomwareCommand),\n            ShadowCopyDeletions = countif(IsShadowCopyDeletion),\n            BootRecoveryDisabled = countif(IsBootRecoveryDisabled),\n            BackupDeletions = countif(IsBackupDeletion),\n            FileWiping = countif(IsFileWiping),\n            PowerShellEncoded = countif(IsPowerShellEncoded),\n            MaxProcessRisk = max(ProcessTotalRisk),\n            AvgProcessRisk = avg(ProcessTotalRisk),\n            SuspiciousCommands = make_set_if(CommandLine, IsRansomwareCommand, 50)\n            by bin(TimeGenerated, 5m), ComputerName\n    ) on TimeGenerated, ComputerName\n    | join kind=leftouter (\n        registryAnalysis\n        | summarize \n            RegistryModifications = count(),\n            BootRegistryChanges = countif(IsBootRegistry),\n            SecurityRegistryChanges = countif(IsSecurityRegistry),\n            RunRegistryChanges = countif(IsRunRegistry),\n            WallpaperChanges = countif(IsWallpaperRegistry),\n            MaxRegistryRisk = max(RegistryRiskScore),\n            ModifiedKeys = make_set(RegistryKey, 100)\n            by bin(TimeGenerated, 5m), ComputerName\n    ) on TimeGenerated, ComputerName\n    | join kind=leftouter (\n        networkActivity\n        | summarize \n            NetworkConnections = count(),\n            UnusualPortConnections = countif(IsUnusualPort),\n            EncryptedConnections = countif(IsEncryptedTraffic),\n            SuspiciousDestinations = dcount(DestinationIP),\n            MaxNetworkRisk = max(NetworkRiskScore),\n            Destinations = make_set(DestinationIP, 100)\n            by bin(TimeGenerated, 5m), ComputerName\n    ) on TimeGenerated, ComputerName\n    | extend \n        // Comprehensive ML-based ransomware behavior score\n        MLRansomwareScore = min_of(\n            round(\n                // File system activity (40% weight)\n                (case(RansomwareExtensionFiles > 0, 50, 0)) +\n                (case(EncryptionPatterns > 0, 30, 0)) +\n                (case(DeleteOperations > 50, 25, DeleteOperations > 10, 15, 0)) +\n                (case(WriteOperations > 100, 20, WriteOperations > 50, 10, 0)) +\n                (case(CriticalShareAccess > 0, 20, 0)) +\n                \n                // Process behavior (30% weight)\n                (coalesce(ShadowCopyDeletions, 0) * 15) +\n                (coalesce(BootRecoveryDisabled, 0) * 12) +\n                (coalesce(BackupDeletions, 0) * 10) +\n                (coalesce(FileWiping, 0) * 8) +\n                (coalesce(PowerShellEncoded, 0) * 6) +\n                \n                // Registry modifications (15% weight)\n                (coalesce(BootRegistryChanges, 0) * 10) +\n                (coalesce(SecurityRegistryChanges, 0) * 8) +\n                (coalesce(RunRegistryChanges, 0) * 6) +\n                (coalesce(WallpaperChanges, 0) * 4) +\n                \n                // Network activity (15% weight)\n                (case(coalesce(UnusualPortConnections, 0) > 0, 15, 0)) +\n                (case(coalesce(SuspiciousDestinations, 0) > 10, 10, 0))\n            , 1),\n            100\n        ),\n        \n        // Ransomware behavior pattern classification\n        RansomwarePattern = case(\n            RansomwareExtensionFiles > 0, \"Active File Encryption\",\n            coalesce(ShadowCopyDeletions, 0) > 0 and coalesce(BootRecoveryDisabled, 0) > 0, \"System Recovery Inhibition\",\n            coalesce(BackupDeletions, 0) > 0 and DeleteOperations > 20, \"Backup Destruction and File Deletion\",\n            EncryptionPatterns > 0 and WriteOperations > 50, \"Mass File Encryption Attempt\",\n            coalesce(PowerShellEncoded, 0) > 0 and TotalFileOperations > 100, \"Encoded PowerShell File Manipulation\",\n            coalesce(WallpaperChanges, 0) > 0 and coalesce(RunRegistryChanges, 0) > 0, \"Ransom Message Display Setup\",\n            CriticalShareAccess > 0 and DeleteOperations > 10, \"Network Share Ransomware Attack\",\n            \"Suspicious Ransomware-like Activity\"\n        ),\n        \n        // Impact assessment\n        ImpactLevel = case(\n            RansomwareExtensionFiles > 0 or \n            (coalesce(ShadowCopyDeletions, 0) > 0 and coalesce(BackupDeletions, 0) > 0), \"Critical\",\n            EncryptionPatterns > 0 or \n            (DeleteOperations > 50 and CriticalShareAccess > 0), \"High\",\n            TotalFileOperations > 100 or \n            coalesce(RansomwareCommands, 0) > 0, \"Medium\",\n            \"Low\"\n        ),\n        \n        // Speed of attack assessment\n        AttackVelocity = case(\n            ActivityDuration <= 5 and TotalFileOperations > 100, \"Very Fast\",\n            ActivityDuration <= 15 and TotalFileOperations > 50, \"Fast\", \n            ActivityDuration <= 30, \"Moderate\",\n            \"Slow\"\n        );\n// Filter results based on threshold and generate alerts\naggregatedAnalysis\n| where MLRansomwareScore >= ransomwareThreshold or RansomwareExtensionFiles > 0 or \n        (coalesce(ShadowCopyDeletions, 0) > 0 and coalesce(BootRecoveryDisabled, 0) > 0)\n| extend \n    // MITRE ATT&CK technique mapping\n    MitreTechnique = case(\n        RansomwareExtensionFiles > 0, \"T1486\",\n        coalesce(ShadowCopyDeletions, 0) > 0 or coalesce(BackupDeletions, 0) > 0, \"T1490\",\n        TotalFileOperations > 100, \"T1083\",\n        \"T1486\"\n    ),\n    MitreTactic = case(\n        RansomwareExtensionFiles > 0 or EncryptionPatterns > 0, \"Impact\",\n        coalesce(ShadowCopyDeletions, 0) > 0, \"Defense Evasion\", \n        \"Discovery\"\n    ),\n    \n    // Dynamic incident severity\n    IncidentSeverity = case(\n        MLRansomwareScore >= 90 or RansomwareExtensionFiles > 0, \"Critical\",\n        MLRansomwareScore >= 80 or ImpactLevel == \"Critical\", \"High\",\n        MLRansomwareScore >= 70 or ImpactLevel == \"High\", \"Medium\",\n        \"Low\"\n    ),\n    \n    // Business continuity impact\n    BusinessImpact = case(\n        CriticalShareAccess > 0 and (RansomwareExtensionFiles > 0 or DeleteOperations > 50), \"Critical - Business operations at risk\",\n        coalesce(BackupDeletions, 0) > 0 and coalesce(ShadowCopyDeletions, 0) > 0, \"High - Data recovery capabilities compromised\",\n        TotalFileOperations > 200, \"Medium - Large scale file manipulation detected\",\n        \"Low - Limited impact detected\"\n    ),\n    \n    // Response recommendations\n    RecommendedActions = case(\n        MLRansomwareScore >= 90, \"IMMEDIATE: Isolate system, preserve forensics, activate incident response, notify management\",\n        RansomwareExtensionFiles > 0, \"URGENT: Network isolation, backup verification, malware analysis, legal consultation\",\n        coalesce(ShadowCopyDeletions, 0) > 0, \"HIGH: System isolation, recovery preparation, forensic imaging, threat hunting\",\n        MLRansomwareScore >= 70, \"Monitor closely, enhance logging, validate system integrity, prepare response\",\n        \"Standard monitoring, document activity, schedule follow-up analysis\"\n    )\n| project \n    TimeGenerated,\n    ComputerName,\n    RansomwarePattern,\n    IncidentSeverity,\n    MLRansomwareScore,\n    ImpactLevel,\n    AttackVelocity,\n    ActivityDuration,\n    TotalFileOperations,\n    RansomwareExtensionFiles,\n    EncryptionPatterns,\n    DeleteOperations,\n    CriticalShareAccess,\n    ShadowCopyDeletions = coalesce(ShadowCopyDeletions, 0),\n    BootRecoveryDisabled = coalesce(BootRecoveryDisabled, 0),\n    BackupDeletions = coalesce(BackupDeletions, 0),\n    FileWiping = coalesce(FileWiping, 0),\n    PowerShellEncoded = coalesce(PowerShellEncoded, 0),\n    RegistryModifications = coalesce(RegistryModifications, 0),\n    NetworkConnections = coalesce(NetworkConnections, 0),\n    MitreTechnique,\n    MitreTactic,\n    BusinessImpact,\n    RecommendedActions,\n    // Evidence for investigation\n    AffectedFiles,\n    RansomwareFiles,\n    ProcessesInvolved,\n    UsersInvolved,\n    SuspiciousCommands = coalesce(SuspiciousCommands, dynamic([])),\n    ModifiedKeys = coalesce(ModifiedKeys, dynamic([])),\n    Destinations = coalesce(Destinations, dynamic([])),\n    // Risk breakdown\n    MaxFileRiskScore,\n    AvgFileRiskScore,\n    MaxProcessRisk = coalesce(MaxProcessRisk, 0),\n    MaxRegistryRisk = coalesce(MaxRegistryRisk, 0),\n    MaxNetworkRisk = coalesce(MaxNetworkRisk, 0),\n    FirstActivity,\n    LastActivity\n| order by MLRansomwareScore desc, RansomwareExtensionFiles desc",
        "entityMappings": [
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "columnName": "ComputerName",
                "identifier": "HostName"
              }
            ]
          },
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "UsersInvolved",
                "identifier": "Name"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "columnName": "AffectedFiles", 
                "identifier": "Name"
              }
            ]
          },
          {
            "entityType": "Process",
            "fieldMappings": [
              {
                "columnName": "ProcessesInvolved",
                "identifier": "ProcessId"
              }
            ]
          }
        ],
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "ML Ransomware Detection: {{ComputerName}} - {{RansomwarePattern}} (Score: {{MLRansomwareScore}}/100)",
          "alertDescriptionFormat": "Advanced ransomware behavior detected: {{RansomwarePattern}}\\n\\nSystem: {{ComputerName}}\\n\\nRansomware Assessment:\\n- ML Behavior Score: {{MLRansomwareScore}}/100\\n- Impact Level: {{ImpactLevel}}\\n- Attack Velocity: {{AttackVelocity}}\\n- Activity Duration: {{ActivityDuration}} minutes\\n- File Operations: {{TotalFileOperations}}\\n- Ransomware Files Created: {{RansomwareExtensionFiles}}\\n- Encryption Patterns: {{EncryptionPatterns}}\\n- Delete Operations: {{DeleteOperations}}\\n- Critical Share Access: {{CriticalShareAccess}}\\n- Shadow Copy Deletions: {{ShadowCopyDeletions}}\\n- Boot Recovery Disabled: {{BootRecoveryDisabled}}\\n- Backup Deletions: {{BackupDeletions}}\\n- MITRE Technique: {{MitreTechnique}}\\n\\nBusiness Impact: {{BusinessImpact}}\\n\\nIMMEDIATE ACTIONS: {{RecommendedActions}}\\n\\nEvidence:\\n- Affected Files: {{AffectedFiles}}\\n- Ransomware Files: {{RansomwareFiles}}\\n- Processes: {{ProcessesInvolved}}\\n- Users: {{UsersInvolved}}\\n- Suspicious Commands: {{SuspiciousCommands}}\\n- Registry Changes: {{ModifiedKeys}}",
          "alertSeverityColumnName": "IncidentSeverity",
          "alertDynamicProperties": [
            {
              "alertProperty": "AlertLink",
              "value": "RansomwarePattern"
            },
            {
              "alertProperty": "ProviderName",
              "value": "ML Ransomware Analytics"
            },
            {
              "alertProperty": "RemediationSteps",
              "value": "RecommendedActions"
            }
          ]
        },
        "customDetails": {
          "RansomwarePattern": "RansomwarePattern",
          "MLRansomwareScore": "MLRansomwareScore", 
          "ImpactLevel": "ImpactLevel",
          "AttackVelocity": "AttackVelocity",
          "MitreTechnique": "MitreTechnique",
          "RansomwareExtensionFiles": "RansomwareExtensionFiles",
          "ShadowCopyDeletions": "ShadowCopyDeletions",
          "BootRecoveryDisabled": "BootRecoveryDisabled",
          "BackupDeletions": "BackupDeletions",
          "BusinessImpact": "BusinessImpact",
          "CriticalShareAccess": "CriticalShareAccess",
          "ActivityDuration": "ActivityDuration"
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "enabled": true,
            "reopenClosedIncident": true,
            "lookbackDuration": "PT2H",
            "matchingMethod": "AllEntities",
            "groupByEntities": ["Host", "Account"],
            "groupByAlertDetails": ["DisplayName"], 
            "groupByCustomDetails": ["RansomwarePattern", "ComputerName"]
          }
        }
      }
    }
  ],
  "outputs": {
    "alertRuleId": {
      "type": "string",
      "value": "[resourceId('Microsoft.OperationalInsights/workspaces/providers/alertRules', parameters('workspaceName'), 'Microsoft.SecurityInsights', parameters('ruleId'))]"
    },
    "alertRuleName": {
      "type": "string",
      "value": "[variables('alertRuleName')]"
    }
  }
}